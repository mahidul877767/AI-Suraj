<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMNI-HUD // NEURAL REACTOR v4.0</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap');
        
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Orbitron', sans-serif; color: #00f2ff; user-select: none; }
        
        /* VIDEO BACKGROUND */
        #video-container { position: absolute; inset: 0; z-index: 0; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); filter: brightness(0.35) contrast(1.5) grayscale(0.2); }

        /* CANVAS */
        canvas { position: absolute; inset: 0; z-index: 10; pointer-events: none; }

        /* HUD ELEMENTS */
        #ui-layer { position: absolute; inset: 0; z-index: 20; pointer-events: none; padding: 25px; }
        
        .panel { 
            background: rgba(0, 15, 25, 0.7); 
            border: 1px solid rgba(0, 242, 255, 0.4); 
            backdrop-filter: blur(12px);
            padding: 15px;
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.15);
        }

        #top-left { position: absolute; top: 25px; left: 25px; border-left: 5px solid #00f2ff; min-width: 250px; }
        #top-right { position: absolute; top: 25px; right: 25px; text-align: right; border-right: 5px solid #00f2ff; }
        #bottom-info { position: absolute; bottom: 25px; left: 25px; font-size: 11px; opacity: 0.8; }
        
        .title { font-weight: 900; letter-spacing: 4px; font-size: 22px; color: #fff; text-shadow: 0 0 10px #00f2ff; }
        .data-row { font-size: 12px; margin-top: 8px; display: flex; justify-content: space-between; }
        .val { color: #fff; font-weight: bold; }

        /* RADAR SYSTEM */
        #hand-radar {
            position: absolute; width: 100px; height: 100px;
            border: 1px solid rgba(0, 242, 255, 0.5); border-radius: 50%;
            display: none; border-style: dashed; animation: spin 5s linear infinite;
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* LOADING */
        #boot-screen {
            position: fixed; inset: 0; background: #000; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <div id="boot-screen">
        <h1 class="title">OMNI_OS v4.0</h1>
        <p id="boot-status" style="font-size: 12px; letter-spacing: 2px;">AUTHORIZING NEURAL LINK...</p>
    </div>

    <div id="video-container"><video id="input-video" playsinline></video></div>
    
    <div id="ui-layer">
        <div id="top-left" class="panel">
            <div class="title" id="mode-ui">SCANNING...</div>
            <div class="data-row">SYNC_RATE: <span class="val" id="sync-val">0ms</span></div>
            <div class="data-row">TIME_DILATION: <span class="val" id="time-val">1.0x</span></div>
        </div>

        <div id="top-right" class="panel">
            <div style="font-size: 10px; opacity: 0.5;">CORE_DIAGNOSTICS</div>
            <div class="data-row">FPS: <span class="val" id="fps">--</span></div>
            <div class="data-row">THEME: <span class="val" id="theme-name">CYBER</span></div>
        </div>

        <div id="bottom-info" class="panel">
            <b>[GESTURES]</b> PINCH: Gravity | FIST: Black Hole | PALM: Shockwave<br>
            <b>[COMMANDS]</b> 1-3: Themes | S: Snapshot | SPACE: Reset Position
        </div>

        <div id="hand-radar"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

    <script>
        const state = { 
            detected: false, mode: 'IDLE', timeScale: 1.0, 
            handPos: new THREE.Vector3(), theme: 1, pinch: false 
        };
        const count = 6000;

        // 1. THREE.JS ENGINE
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.z = 75;

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const composer = new THREE.EffectComposer(renderer);
        composer.addPass(new THREE.RenderPass(scene, camera));
        const bloom = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.8, 0.4, 0.85);
        composer.addPass(bloom);

        // 2. PARTICLE & GEOMETRY
        const geometry = new THREE.BufferGeometry();
        const posArr = new Float32Array(count * 3);
        const colArr = new Float32Array(count * 3);
        const baseSphere = [];

        for(let i=0; i<count; i++) {
            const i3 = i * 3;
            posArr[i3] = (Math.random()-0.5)*250;
            posArr[i3+1] = (Math.random()-0.5)*250;
            posArr[i3+2] = (Math.random()-0.5)*100;

            const phi = Math.acos(1 - 2*i/count);
            const theta = Math.PI * (1 + Math.sqrt(5)) * i;
            baseSphere.push(35*Math.cos(theta)*Math.sin(phi), 35*Math.sin(theta)*Math.sin(phi), 35*Math.cos(phi));
        }
        geometry.setAttribute('position', new THREE.BufferAttribute(posArr, 3));
        geometry.setAttribute('color', new THREE.BufferAttribute(colArr, 3));

        const mat = new THREE.PointsMaterial({ size: 1.4, vertexColors: true, transparent: true, blending: THREE.AdditiveBlending });
        const particles = new THREE.Points(geometry, mat);
        scene.add(particles);

        // 3. THEME LOGIC
        function updateTheme() {
            const themes = { 1: {n: 'CYBER', h: 0.5}, 2: {n: 'SOLAR', h: 0.05}, 3: {n: 'PHANTOM', h: 0.75} };
            document.getElementById('theme-name').innerText = themes[state.theme].n;
            return themes[state.theme].h;
        }

        // 4. MAIN ANIMATION LOOP
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta() * state.timeScale;
            const time = clock.getElapsedTime();
            
            document.getElementById('fps').innerText = Math.round(1/(dt/state.timeScale || 0.01));
            document.getElementById('time-val').innerText = state.timeScale.toFixed(1) + 'x';

            const p = geometry.attributes.position.array;
            const c = geometry.attributes.color.array;
            const h = updateTheme();

            for(let i=0; i<count; i++) {
                const i3 = i * 3;
                let tx, ty, tz;
                let ease = 0.06 * state.timeScale;

                if(!state.detected) {
                    tx = baseSphere[i3] + Math.sin(time + i*0.1)*3;
                    ty = baseSphere[i3+1] + Math.cos(time + i*0.1)*3;
                    tz = baseSphere[i3+2];
                } else {
                    if(state.pinch) { // Singularity
                        tx = state.handPos.x; ty = state.handPos.y; tz = 0;
                        ease = 0.25;
                    } else if(state.mode === 'SINGULARITY') {
                        tx = state.handPos.x; ty = state.handPos.y; tz = 0;
                        ease = 0.12;
                    } else if(state.mode === 'REPEL') {
                        const dx = p[i3] - state.handPos.x, dy = p[i3+1] - state.handPos.y;
                        const d = Math.sqrt(dx*dx + dy*dy) + 0.1;
                        tx = p[i3] + (dx/d)*15; ty = p[i3+1] + (dy/d)*15; tz = p[i3+2];
                        ease = 0.15;
                    } else {
                        tx = baseSphere[i3] + state.handPos.x;
                        ty = baseSphere[i3+1] + state.handPos.y;
                        tz = baseSphere[i3+2];
                    }
                }

                p[i3] += (tx - p[i3]) * ease;
                p[i3+1] += (ty - p[i3+1]) * ease;
                p[i3+2] += (tz - p[i3+2]) * ease;

                const col = new THREE.Color().setHSL(h + Math.sin(time*0.5 + i*0.001)*0.05, 0.8, 0.6);
                c[i3] = col.r; c[i3+1] = col.g; c[i3+2] = col.b;
            }

            geometry.attributes.position.needsUpdate = true;
            geometry.attributes.color.needsUpdate = true;
            composer.render();
        }

        // 5. GESTURE & CAMERA SYSTEM
        function onResults(results) {
            document.getElementById('boot-screen').style.display = 'none';
            const radar = document.getElementById('hand-radar');
            
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                state.detected = true;
                const lm = results.multiHandLandmarks[0];
                
                // Radar Position
                radar.style.display = 'block';
                radar.style.left = (1 - lm[9].x) * window.innerWidth - 50 + 'px';
                radar.style.top = lm[9].y * window.innerHeight - 50 + 'px';

                // Neural Logic
                state.timeScale = THREE.MathUtils.mapLinear(1 - lm[9].y, 0, 1, 0.2, 3.5);
                state.handPos.lerp(new THREE.Vector3((0.5 - lm[9].x)*160, (0.5 - lm[9].y)*110, 0), 0.2);

                const d = (p1, p2) => Math.sqrt(Math.pow(lm[p1].x-lm[p2].x,2) + Math.pow(lm[p1].y-lm[p2].y,2));
                state.pinch = d(4, 8) < 0.035;
                
                const f = [8,12,16,20].filter(i => lm[i].y < lm[i-2].y).length;
                if(state.pinch) state.mode = 'GRAVITY_CORE';
                else if(f === 0) state.mode = 'SINGULARITY';
                else if(f >= 4) state.mode = 'REPEL';
                else state.mode = 'NEURAL_LINK';

                document.getElementById('mode-ui').innerText = state.mode;
            } else {
                state.detected = false;
                radar.style.display = 'none';
                document.getElementById('mode-ui').innerText = 'SEARCHING...';
            }
        }

        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6});
        hands.onResults(onResults);

        const video = document.getElementById('input-video');
        const cam = new Camera(video, {onFrame: async () => { await hands.send({image: video}); }, width: 1280, height: 720});
        cam.start();

        // 6. SYSTEM UTILS
        window.addEventListener('keydown', (e) => {
            if(e.key === '1') state.theme = 1;
            if(e.key === '2') state.theme = 2;
            if(e.key === '3') state.theme = 3;
            if(e.key.toLowerCase() === 's') {
                const link = document.createElement('a');
                link.download = 'omni_capture.png';
                link.href = renderer.domElement.toDataURL();
                link.click();
            }
        });

        animate();
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
